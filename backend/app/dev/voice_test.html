<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dyslexia Voice Test â€“ Dev Tool</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f7fb;
      padding: 30px;
    }

    h1 {
      color: #222;
    }

    .box {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      max-width: 600px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    input, select, button {
      padding: 10px;
      margin-top: 6px;
      width: 100%;
      font-size: 16px;
    }

    button {
      cursor: pointer;
      margin-top: 15px;
    }

    .output {
      margin-top: 15px;
      padding: 10px;
      background: #eef2ff;
      border-radius: 6px;
      font-weight: bold;
    }

    .error {
      color: #b91c1c;
      margin-top: 10px;
    }

    .success {
      color: #065f46;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<h1>ğŸ¤ Dyslexia Voice Test (Browser STT + TTS)</h1>

<div class="box">

  <!-- TOKEN -->
  <label>ğŸ”‘ JWT Token</label>
  <input id="tokenInput" placeholder="Paste JWT token here" />

  <button onclick="connectBackend()">ğŸ”Œ Connect Backend</button>

  <!-- LEVEL -->
  <label>ğŸ“š Select Level</label>
  <select id="levelSelect" onchange="loadWords()"></select>

  <!-- WORD -->
  <label>ğŸ“ Select Word</label>
  <select id="wordSelect"></select>

  <!-- PACE MODE -->
  <label>â± Pace Mode</label>
  <select id="paceMode" onchange="toggleCustomPace()">
    <option value="slow">Slow</option>
    <option value="medium" selected>Medium</option>
    <option value="fast">Fast</option>
    <option value="custom">Custom</option>
  </select>

  <!-- CUSTOM PACE -->
  <label>ğŸš Custom Pace (40â€“200)</label>
  <input id="customPace" type="number" min="40" max="200" value="80" disabled />

  <!-- ACTIONS -->
  <button onclick="playTTS()">ğŸ”Š Play TTS</button>
  <button onclick="startSTT()">ğŸ™ Speak</button>
  <button onclick="evaluatePronunciation()">ğŸ§ª Evaluate</button>

  <div id="output" class="output"></div>
  <div id="error" class="error"></div>

</div>

<script>
const API_BASE = "http://127.0.0.1:8000";
let spokenText = "";

// -------------------------
// CONNECT
// -------------------------
async function connectBackend() {
  clearMsg();

  const token = document.getElementById("tokenInput").value.trim();
  if (!token) {
    showError("JWT token required");
    return;
  }

  window.AUTH_HEADER = {
    "Authorization": "Bearer " + token
  };

  await loadLevels();
}

// -------------------------
// LOAD LEVELS
// -------------------------
async function loadLevels() {
  clearMsg();
  console.log("ğŸ“¤ Fetching levels...");

  const res = await fetch(`${API_BASE}/learning/levels`, {
    headers: AUTH_HEADER
  });

  if (!res.ok) {
    showError("Failed to load levels");
    return;
  }

  const levels = await res.json();
  console.log("ğŸ“¥ Levels:", levels);

  const levelSelect = document.getElementById("levelSelect");
  levelSelect.innerHTML = "";

  levels.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l.id;
    opt.textContent = `Level ${l.id}: ${l.name}`;
    levelSelect.appendChild(opt);
  });

  await loadWords();
}

// -------------------------
// LOAD WORDS
// -------------------------
async function loadWords() {
  clearMsg();

  const levelId = document.getElementById("levelSelect").value;
  console.log("ğŸ“¤ Fetching words for level", levelId);

  const res = await fetch(
    `${API_BASE}/learning/levels/${levelId}/words`,
    { headers: AUTH_HEADER }
  );

  const wordSelect = document.getElementById("wordSelect");
  wordSelect.innerHTML = "";

  if (res.status === 401) {
    showError("ğŸ”’ Level locked. Complete mock test to unlock.");
    wordSelect.disabled = true;
    return;
  }

  const words = await res.json();
  console.log("ğŸ“¥ Words:", words);

  wordSelect.disabled = false;

  words.forEach(w => {
    const opt = document.createElement("option");
    opt.value = w.word_id || w.id;
    opt.textContent = w.word || w.text;
    wordSelect.appendChild(opt);
  });
}

// -------------------------
// TTS
// -------------------------
function playTTS() {
  clearMsg();

  const word = document.getElementById("wordSelect").selectedOptions[0]?.text;
  if (!word) {
    showError("Select a word first");
    return;
  }

  const mode = document.getElementById("paceMode").value;
  const custom = Number(document.getElementById("customPace").value);

  const utterance = new SpeechSynthesisUtterance(word);

  if (mode === "slow") utterance.rate = 0.6;
  if (mode === "medium") utterance.rate = 0.85;
  if (mode === "fast") utterance.rate = 1.1;
  if (mode === "custom") utterance.rate = custom / 100;

  utterance.pitch = 1;
  utterance.volume = 1;

  speechSynthesis.cancel();
  speechSynthesis.speak(utterance);

  console.log("ğŸ”Š TTS:", word, mode);
}

// -------------------------
// STT
// -------------------------
function startSTT() {
  clearMsg();

  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    showError("Speech recognition not supported");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;

  recognition.onresult = e => {
    spokenText = e.results[0][0].transcript;
    document.getElementById("output").innerText =
      "ğŸ§  You said: " + spokenText;
    console.log("ğŸ™ STT:", spokenText);
  };

  recognition.onerror = e => showError("STT error");

  recognition.start();
}

// -------------------------
// EVALUATE
// -------------------------
async function evaluatePronunciation() {
  clearMsg();

  if (!spokenText) {
    showError("ğŸ™ Please speak first");
    return;
  }

  const wordSelect = document.getElementById("wordSelect");
  const wordId = wordSelect.value;
  const wordText = wordSelect.selectedOptions[0]?.text;

  if (!wordId) {
    showError("ğŸ“˜ Please select a word");
    return;
  }

  console.log("ğŸ§ª Evaluating:", {
    word_id: wordId,
    recognized_text: spokenText
  });

  const res = await fetch(`${API_BASE}/practice/evaluate`, {
    method: "POST",
    headers: {
      ...AUTH_HEADER,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      word_id: Number(wordId),
      recognized_text: spokenText
    })
  });

  if (!res.ok) {
    const err = await res.text();
    console.error("âŒ Evaluation failed:", err);
    showError("Evaluation failed â€” check console");
    return;
  }

  const result = await res.json();
  console.log("âœ… Evaluation result:", result);

  document.getElementById("output").innerText =
`ğŸ“˜ Word: ${result.expected}
ğŸ—£ You said: ${result.recognized}
ğŸ“Š Score: ${result.score}
âš– Verdict: ${result.verdict}
ğŸ† Correct: ${result.is_correct ? "Yes" : "No"}`;
}

// -------------------------
function toggleCustomPace() {
  const mode = document.getElementById("paceMode").value;
  document.getElementById("customPace").disabled = mode !== "custom";
}

function showError(msg) {
  document.getElementById("error").innerText = msg;
}

function clearMsg() {
  document.getElementById("error").innerText = "";
}
</script>

</body>
</html>
