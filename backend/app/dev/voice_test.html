<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dyslexia Voice Test ‚Äì Learning Debug Tool</title>

  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      background: #f6f7fb;
      padding: 30px;
    }

    h1 {
      color: #111;
      margin-bottom: 10px;
    }

    p.subtitle {
      color: #555;
      margin-bottom: 25px;
    }

    .box {
      background: #fff;
      padding: 22px;
      border-radius: 10px;
      max-width: 720px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 16px;
    }

    input, select, button {
      margin-top: 6px;
      padding: 10px;
      width: 100%;
      font-size: 15px;
    }

    button {
      cursor: pointer;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 6px;
    }

    button.secondary {
      background: #0f766e;
    }

    button.warn {
      background: #b91c1c;
    }

    .row {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .row button {
      flex: 1;
    }

    img.word-image {
      margin-top: 14px;
      max-width: 160px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    pre.output {
      background: #eef2ff;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .error {
      color: #b91c1c;
      margin-top: 10px;
      font-weight: 600;
    }
  </style>
</head>

<body>

<h1>üé§ Dyslexia Voice Test</h1>
<p class="subtitle">Browser STT + TTS ‚Ä¢ Learning DB Pipeline ‚Ä¢ Debug Console</p>

<div class="box">

  <!-- AUTH -->
  <label>üîë JWT Token</label>
  <input id="tokenInput" placeholder="Paste JWT token here" />
  <button onclick="connectBackend()">üîå Connect Backend</button>

  <!-- LEVEL -->
  <label>üìö Level</label>
  <select id="levelSelect" onchange="loadWords()"></select>

  <!-- WORD -->
  <label>üìù Word</label>
  <select id="wordSelect" onchange="updateImage()"></select>

  <img id="wordImage" class="word-image" />

  <!-- PACE -->
  <label>‚è± Pace Mode</label>
  <select id="paceMode" onchange="toggleCustomPace()">
    <option value="slow">Slow</option>
    <option value="medium" selected>Medium</option>
    <option value="fast">Fast</option>
    <option value="custom">Custom</option>
  </select>

  <label>üéö Custom Pace (40‚Äì200)</label>
  <input id="customPace" type="number" min="40" max="200" value="80" disabled />

  <!-- ACTIONS -->
  <div class="row">
    <button onclick="playTTS()">üîä Play TTS</button>
    <button class="secondary" onclick="startSTT()">üéô Speak</button>
    <button class="warn" onclick="evaluateAndLearn()">üß™ Evaluate</button>
  </div>

  <!-- OUTPUT -->
  <pre id="output" class="output"></pre>
  <pre id="feedbackBox" class="output"></pre>
  <pre id="recommendationBox" class="output"></pre>

  <div id="error" class="error"></div>

</div>

<script>
const API_BASE = "http://127.0.0.1:8000";
const STATIC_ASSETS = "https://dyslexia-static-assets.onrender.com";

let AUTH_HEADER = {};
let spokenText = "";

// ---------------- CONNECT ----------------
async function connectBackend() {
  clearMsg();

  const token = tokenInput.value.trim();
  if (!token) return showError("JWT token required");

  AUTH_HEADER = { Authorization: "Bearer " + token };

  await loadLevels();
}

// ---------------- LEVELS ----------------
async function loadLevels() {
  const res = await fetch(`${API_BASE}/learning/levels`, { headers: AUTH_HEADER });
  if (!res.ok) return showError("Failed to load levels");

  const levels = await res.json();
  levelSelect.innerHTML = "";

  levels.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l.id;
    opt.textContent = `Level ${l.id}: ${l.name}`;
    levelSelect.appendChild(opt);
  });

  await loadWords();
}

// ---------------- WORDS ----------------
async function loadWords() {
  clearMsg();
  const levelId = levelSelect.value;

  const res = await fetch(
    `${API_BASE}/learning/levels/${levelId}/words`,
    { headers: AUTH_HEADER }
  );

  wordSelect.innerHTML = "";

  if (res.status === 401) {
    showError("üîí Level locked ‚Äî complete mock test");
    return;
  }

  const words = await res.json();

  words.forEach(w => {
    const opt = document.createElement("option");
    opt.value = w.word_id || w.id;
    opt.textContent = w.word || w.text;
    wordSelect.appendChild(opt);
  });

  updateImage();
}

// ---------------- IMAGE ----------------
function updateImage() {
  const word = wordSelect.selectedOptions[0]?.text;
  if (!word) return;
  wordImage.src = `${STATIC_ASSETS}/images/words/${word}.jpg`;
}

// ---------------- TTS ----------------
function playTTS() {
  const word = wordSelect.selectedOptions[0]?.text;
  if (!word) return showError("Select a word");

  const mode = paceMode.value;
  const custom = Number(customPace.value);

  const u = new SpeechSynthesisUtterance(word);

  if (mode === "slow") u.rate = 0.6;
  if (mode === "medium") u.rate = 0.85;
  if (mode === "fast") u.rate = 1.1;
  if (mode === "custom") u.rate = custom / 100;

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

// ---------------- STT ----------------
function startSTT() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return showError("Speech recognition not supported");

  const r = new SR();
  r.lang = "en-US";

  r.onresult = e => {
    spokenText = e.results[0][0].transcript;
    output.innerText = `üß† You said: ${spokenText}`;
  };

  r.start();
}

// ---------------- EVALUATE + LEARN ----------------
async function evaluateAndLearn() {
  clearMsg();

  if (!spokenText) return showError("Speak first");

  const wordId = Number(wordSelect.value);
  const levelId = Number(levelSelect.value);

  // 1Ô∏è‚É£ Pure evaluation
  const evalRes = await fetch(`${API_BASE}/practice/evaluate`, {
    method: "POST",
    headers: { ...AUTH_HEADER, "Content-Type": "application/json" },
    body: JSON.stringify({ word_id: wordId, recognized_text: spokenText })
  });

  const evalData = await evalRes.json();

  output.innerText =
`üìò Expected: ${evalData.expected}
üó£ Spoken: ${evalData.recognized}
üìä Score: ${evalData.score}
‚öñ Verdict: ${evalData.verdict}`;

  // 2Ô∏è‚É£ Learning DB update
  const form = new FormData();
  form.append("level_id", levelId);
  form.append("word_id", wordId);
  form.append("pace_mode", paceMode.value);
  if (paceMode.value === "custom") {
    form.append("pace_value", customPace.value);
  }
  form.append("spoken", spokenText);
  form.append("file", new Blob([]), "dummy.wav");

  const learnRes = await fetch(`${API_BASE}/learning/learn-auto`, {
    method: "POST",
    headers: AUTH_HEADER,
    body: form
  });

  const learnData = await learnRes.json();

  feedbackBox.innerText = "üí¨ FEEDBACK\n" + JSON.stringify(learnData.feedback, null, 2);
  recommendationBox.innerText =
    "üß≠ RECOMMENDATION\n" + JSON.stringify(learnData.recommendation, null, 2);
}

// ---------------- HELPERS ----------------
function toggleCustomPace() {
  customPace.disabled = paceMode.value !== "custom";
}

function showError(msg) {
  error.innerText = msg;
}

function clearMsg() {
  error.innerText = "";
}
</script>

</body>
</html>
