<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Dyslexia Dynamic Learning üå±</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6fb;
  padding:40px;
  color:#1f2937;
}

.container{
  max-width:900px;
  margin:auto;
  background:white;
  padding:30px;
  border-radius:12px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
}

h1{
  text-align:center;
  margin-bottom:10px;
}

.subtitle{
  text-align:center;
  color:#6b7280;
  margin-bottom:30px;
}

input, textarea, select{
  width:100%;
  padding:12px;
  margin-top:8px;
  margin-bottom:15px;
  border-radius:8px;
  border:1px solid #ddd;
  font-size:16px;
}

button{
  padding:10px 18px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-right:10px;
  font-weight:bold;
}

.primary{ background:#2563eb; color:white; }
.success{ background:#16a34a; color:white; }
.warning{ background:#f59e0b; color:white; }
.danger{ background:#dc2626; color:white; }

.result-box{
  margin-top:20px;
  padding:15px;
  border-radius:10px;
  background:#f9fafb;
}

.word-green{ color:#16a34a; font-weight:bold; }
.word-red{ color:#dc2626; font-weight:bold; }
.word-orange{ color:#f59e0b; font-weight:bold; }

hr{ margin:25px 0; }
</style>
</head>

<body>
<div class="container">

<h1>üå± Dynamic Learning Module</h1>
<p class="subtitle">Practice words, phrases or sentences in a dyslexia-friendly way.</p>

<!-- AUTH -->
<label>üîê Enter JWT Token</label>
<input id="tokenInput" placeholder="Paste your access token here..." />

<button class="primary" onclick="connectBackend()">Connect Backend</button>

<hr/>

<!-- TEXT INPUT -->
<label>‚úçÔ∏è Enter Word / Phrase / Sentence</label>
<textarea id="userText" rows="3" placeholder="Example: Hello my name is Tharun"></textarea>

<button class="primary" onclick="analyzeText()">Analyze</button>
<button class="success" onclick="playTTS()">üîä Play Text</button>

<!-- PACE -->
<label>üéµ TTS Pace</label>
<input type="range" id="paceSlider" min="0.5" max="1.5" step="0.1" value="1" />
<span id="paceValue">1</span>

<hr/>

<!-- MEANING -->
<div id="meaningBox" class="result-box"></div>
<button class="success" onclick="playMeaningTTS()">üîä Play Meaning</button>

<!-- PRACTICE -->
<button class="warning" onclick="startPractice()">üé§ Start Practice</button>

<div id="practiceResult" class="result-box"></div>

<div id="insightsBox" class="result-box"></div>

</div>

<script>

const API = "http://127.0.0.1:8000";
let AUTH = {};
let isConnected = false;

const analyzeCache = {};
const feedbackCache = {};

const slider = document.getElementById("paceSlider");
slider.oninput = () => {
  document.getElementById("paceValue").innerText = slider.value;
};

function connectBackend(){
  const token = document.getElementById("tokenInput").value.trim();
  if(!token){
    alert("Enter token first");
    return;
  }

  AUTH = {
    Authorization: `Bearer ${token}`
  };

  isConnected = true;

  console.log("Connected with token:", token);
  alert("Backend Connected ‚úÖ");
}

function normalize(text){
  return text.toLowerCase().replace(/[^a-zA-Z\s]/g,"").trim();
}

function getText(){
  return document.getElementById("userText").value.trim();
}

/* ======================
   ANALYZE
====================== */

async function analyzeText(){
  if(!isConnected) return alert("Connect backend first");

  const text = getText();
  if(!text) return;

  if(analyzeCache[text]){
    renderMeaning(analyzeCache[text]);
    return;
  }

  const res = await fetch(`${API}/dynamic/analyze`,{
    method:"POST",
    headers:{...AUTH,"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });

  const data = await res.json();
  analyzeCache[text] = data;

  renderMeaning(data);
}

function renderMeaning(data){
  document.getElementById("meaningBox").innerHTML =
    `<strong>üìò Type:</strong> ${data.type}<br/><br/>
     <strong>üß† Meaning:</strong><br/>${data.meaning}`;
}

/* ======================
   TTS (INDEPENDENT)
====================== */

function playTTS(){
  let text = getText();
  if(!text) return;

  if(!/[.!?]$/.test(text)){
    text += ".";
  }

  const utter = new SpeechSynthesisUtterance(text);
  utter.rate = parseFloat(slider.value);
  utter.pitch = 1.05;
  utter.volume = 1;

  speechSynthesis.speak(utter);
}

    function playMeaningTTS(){
    const box = document.getElementById("meaningBox");
    const text = box.innerText;
    if(!text) return;

    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 0.9;
    utter.pitch = 1;
    utter.volume = 1;

    speechSynthesis.speak(utter);
    }

/* ======================
   STT PRACTICE
====================== */

function startPractice(){
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if(!SpeechRecognition){
    alert("Speech Recognition not supported.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 3;

  recognition.onresult = async (e)=>{
    const spoken = normalize(e.results[0][0].transcript);
    await evaluatePractice(spoken);
  };

  recognition.start();
}

function similarity(a,b){
  let longer = a.length > b.length ? a : b;
  let shorter = a.length > b.length ? b : a;
  let same = 0;
  for(let i=0;i<shorter.length;i++){
    if(a[i]===b[i]) same++;
  }
  return same/longer.length;
}

async function evaluatePractice(spoken){
  const expectedRaw = getText();
  const expected = normalize(expectedRaw);

  const expectedWords = expected.split(" ");
  const spokenWords = spoken.split(" ");

  let scoreCount = 0;
  let html = "<strong>üìù Word Comparison</strong><br/><br/>";

  expectedWords.forEach(word=>{
    const match = spokenWords.find(sw=>similarity(sw,word)>0.8);

    if(spokenWords.includes(word)){
      html+=`<span class="word-green">${word}</span> `;
      scoreCount++;
    }
    else if(match){
      html+=`<span class="word-orange">${word}</span> `;
      scoreCount+=0.5;
    }
    else{
      html+=`<span class="word-red">${word}</span> `;
    }
  });

  const extra = spokenWords.filter(sw=>!expectedWords.includes(sw));
  if(extra.length){
    html+="<br/><br/><strong>Extra Words:</strong> ";
    extra.forEach(w=>{
      html+=`<span class="word-orange">${w}</span> `;
    });
  }

  const score = Math.round((scoreCount/expectedWords.length)*100);
  html+=`<br/><br/><strong>üéØ Score:</strong> ${score}%`;

  document.getElementById("practiceResult").innerHTML = html;

  await saveAttempt(expectedRaw, spoken, score);
  await loadAggregateFeedback(expectedRaw, spoken, score);
}

/* ======================
   SAVE ATTEMPT
====================== */

async function saveAttempt(text, spoken, score){
  if(!isConnected) return;

  await fetch(`${API}/dynamic/attempt`,{
    method:"POST",
    headers:{...AUTH,"Content-Type":"application/json"},
    body:JSON.stringify({
      text: text,
      text_type: text.includes(" ") ? "sentence" : "word",
      spoken: spoken,
      score: Number(score),
      pace: parseFloat(slider.value)
    })
  });
}
/* ======================
   AGGREGATE FEEDBACK
====================== */

async function loadAggregateFeedback(word, spoken, score){

  const key = word + "_" + spoken;

  if(feedbackCache[key]){
    renderInsights(feedbackCache[key]);
    return;
  }

  const payload = {
    mode: "dynamic",
    content_type: word.includes(" ") ? "sentence" : "word",
    text: word,
    spoken: spoken,
    score: Number(score),
    attempts: 1,
    pace: parseFloat(slider.value)
    };

  const res = await fetch(`${API}/feedback/aggregate`,{
    method:"POST",
    headers:{...AUTH,"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    console.error("Aggregate failed", await res.text());
    return;
  }

  const data = await res.json();

  feedbackCache[key] = data;

  renderInsights(data);
}

function renderInsights(data){
  let html="<strong>üß† Insights</strong><br/><br/>";

  if(data.feedback){
    html+=`<strong>Verdict:</strong> ${data.feedback.verdict}<br/>`;
    data.feedback.feedback.forEach(f=>{
      html+=`‚Ä¢ ${f}<br/>`;
    });
    html+=`<br/><em>${data.feedback.confidence_tip}</em><br/><br/>`;
  }

  if(data.recommendation){
    html+=`<strong>‚û°Ô∏è ${data.recommendation.headline}</strong><br/>`;
    html+=`${data.recommendation.explanation}<br/><br/>`;
    data.recommendation.next_steps.forEach(s=>{
      html+=`‚Ä¢ ${s}<br/>`;
    });
  }

  document.getElementById("insightsBox").innerHTML = html;
}

</script>
</body>
</html>
