<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dynamic Learning ‚Ä¢ Dyslexia EmpowerHub</title>

<style>
body {
    font-family: "Segoe UI", sans-serif;
    background: #f2f5f9;
    margin: 0;
    padding: 40px;
    color: #2b2b2b;
}

.container {
    max-width: 820px;
    margin: auto;
    background: white;
    padding: 35px;
    border-radius: 18px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.08);
}

h1 { text-align: center; margin-bottom: 5px; }
.subtitle { text-align: center; color: #666; margin-bottom: 30px; }

.section { margin-bottom: 30px; }

label { font-weight: 600; display: block; margin-bottom: 6px; }

input[type="text"], textarea, select {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-bottom: 10px;
}

textarea { resize: none; font-size: 18px; }

button {
    padding: 10px 16px;
    font-size: 15px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    margin-right: 8px;
    margin-top: 8px;
}

.primary { background: #2563eb; color: white; }
.secondary { background: #e5e7eb; }
.success { background: #16a34a; color: white; }

.status { margin-top: 8px; font-weight: 600; }

.output {
    margin-top: 20px;
    padding: 15px;
    background: #f9fafb;
    border-radius: 10px;
    line-height: 1.6;
}

.score { margin-top: 15px; font-weight: 600; }

.instructions {
    font-size: 14px;
    color: #555;
    margin-bottom: 10px;
}

.slider-container {
    margin-top: 10px;
    display: none;
}

</style>
</head>

<body>

<div class="container">

<h1>üìò Dynamic Learning Module</h1>
<div class="subtitle">
Explore any word or sentence. Listen. Understand. Practice.
</div>

<!-- AUTH -->
<div class="section">
<label>üîê JWT Token</label>
<input type="text" id="tokenInput" placeholder="Paste your JWT token here..." />
<button class="primary" onclick="connectBackend()">Connect Backend</button>
<div class="status" id="connectionStatus">Status: Not Connected</div>
</div>

<!-- INPUT -->
<div class="section">
<label>‚úçÔ∏è Enter a Word or Sentence</label>
<div class="instructions">
Type something you want to understand. Then adjust the listening pace if needed.
</div>

<textarea id="inputText" rows="3" placeholder="Example: Good morning"></textarea>

<!-- Pace Control -->
<label>üéö Listening Pace</label>
<select id="paceMode" onchange="updatePaceMode()">
    <option value="slow">Slow</option>
    <option value="medium" selected>Medium</option>
    <option value="fast">Fast</option>
    <option value="custom">Custom</option>
</select>

<div class="slider-container" id="customPaceContainer">
    <input type="range" id="customPace" min="0.5" max="1.5" step="0.05" value="0.9"
           oninput="updateCustomPaceValue()" />
    <div id="paceValue">Rate: 0.9</div>
</div>

<button class="primary" onclick="analyzeText()">Analyze Meaning</button>
<button class="secondary" onclick="speakOriginal()">üîä Listen to Text</button>
<button class="secondary" onclick="speakMeaning()">üîä Listen to Meaning</button>
<button class="success" onclick="startPractice()">üé§ Practice Speaking</button>
</div>

<!-- OUTPUT -->
<div class="section">
<div class="output" id="result"></div>
<div class="score" id="score"></div>
</div>

</div>

<script>

const API = "http://127.0.0.1:8000";
let AUTH = {};
let isConnected = false;
let currentMeaning = "";
const dynamicCache = {};

// ----------------------------
// Pace Control
// ----------------------------
function getSpeechRate() {
    const mode = document.getElementById("paceMode").value;

    if (mode === "slow") return 0.75;
    if (mode === "medium") return 0.9;
    if (mode === "fast") return 1.1;
    if (mode === "custom") {
        return parseFloat(document.getElementById("customPace").value);
    }
}

function updatePaceMode() {
    const mode = document.getElementById("paceMode").value;
    document.getElementById("customPaceContainer").style.display =
        mode === "custom" ? "block" : "none";
}

function updateCustomPaceValue() {
    const val = document.getElementById("customPace").value;
    document.getElementById("paceValue").innerText = `Rate: ${val}`;
}

// ----------------------------
// Connect
// ----------------------------
function connectBackend() {
    const token = document.getElementById("tokenInput").value.trim();
    if (!token) return alert("Enter a valid JWT token.");

    AUTH = { Authorization: "Bearer " + token };
    isConnected = true;

    document.getElementById("connectionStatus").innerText =
        "Status: ‚úÖ Connected";
}

// ----------------------------
// Helpers
// ----------------------------
function normalize(text) {
    return text.toLowerCase().trim();
}

function getCurrentText() {
    return document.getElementById("inputText").value.trim();
}

// ----------------------------
// Analyze (AI Meaning Only)
// ----------------------------
async function analyzeText() {
    if (!isConnected) return alert("Connect backend first.");

    const text = getCurrentText();
    if (!text) return;

    const key = normalize(text);

    if (dynamicCache[key]) {
        displayResult(dynamicCache[key]);
        return;
    }

    const res = await fetch(`${API}/dynamic/analyze`, {
        method: "POST",
        headers: { ...AUTH, "Content-Type": "application/json" },
        body: JSON.stringify({ text })
    });

    const data = await res.json();
    dynamicCache[key] = data;
    displayResult(data);
}

function displayResult(data) {
    currentMeaning = data.meaning;

    document.getElementById("result").innerHTML =
        `<strong>Type:</strong> ${data.type}<br/><br/>
         <strong>Meaning:</strong><br/>${data.meaning}`;

    document.getElementById("score").innerText = "";
}

// ----------------------------
// TTS (Independent)
// ----------------------------
function speakOriginal() {
    const text = getCurrentText();
    if (!text) return;

    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = getSpeechRate();
    speechSynthesis.speak(utter);
}

function speakMeaning() {
    if (!currentMeaning) return;

    const utter = new SpeechSynthesisUtterance(currentMeaning);
    utter.rate = getSpeechRate();
    speechSynthesis.speak(utter);
}

// ----------------------------
// STT Practice (Independent)
// ----------------------------
function startPractice() {
    const expected = getCurrentText();
    if (!expected) return;

    const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = function (event) {
        const spoken = normalize(event.results[0][0].transcript);
        evaluatePractice(spoken);
    };

    recognition.start();
}

// ----------------------------
// Word-Based Similarity
// ----------------------------
function evaluatePractice(spoken) {
    const expected = normalize(getCurrentText());

    const expectedWords = expected.split(" ");
    const spokenWords = spoken.split(" ");

    const correct = expectedWords.filter(w => spokenWords.includes(w));
    const missing = expectedWords.filter(w => !spokenWords.includes(w));
    const extra = spokenWords.filter(w => !expectedWords.includes(w));

    const score = Math.round((correct.length / expectedWords.length) * 100);

    renderComparison(correct, missing, extra, score);

    saveAttempt(expected, spoken, score);
}

function renderComparison(correct, missing, extra, score) {
    let html = "<strong>Comparison:</strong><br/><br/>";

    correct.forEach(w => {
        html += `<span style="color:green;">${w}</span> `;
    });

    missing.forEach(w => {
        html += `<span style="color:red;">${w} (missing)</span> `;
    });

    extra.forEach(w => {
        html += `<span style="color:red;">${w} (extra)</span> `;
    });

    document.getElementById("score").innerHTML =
        `üéØ Match Score: ${score}%<br/><br/>${html}`;
}

// ----------------------------
// Save Attempt to Backend
// ----------------------------
async function saveAttempt(text, spoken, score) {
    if (!isConnected) return;

    const textType = text.includes(" ") ? "sentence" : "word";
    const pace = getSpeechRate();

    await fetch(`${API}/dynamic/attempt`, {
        method: "POST",
        headers: { ...AUTH, "Content-Type": "application/json" },
        body: JSON.stringify({
            text,
            text_type: textType,
            spoken,
            score,
            pace
        })
    });
}

</script>

</body>
</html>
